stage('Update K8s Manifest') {
    when { branch 'main' }
    steps {
        script {
            withCredentials([usernamePassword(
                credentialsId: 'github-creds',
                usernameVariable: 'GIT_USERNAME',
                passwordVariable: 'GIT_TOKEN'
            )]) {
                sh """
                    set -e

                    git config user.name "${GIT_USER}"
                    git config user.email "${GIT_EMAIL}"

                    git fetch origin
                    git checkout main
                    git reset --hard origin/main

                    DEPLOY_FILE="k8s/deployment.yaml"

                    sed -i "s|image:.*|image: ${IMAGE_NAME}:build-${BUILD_NUMBER}|" "\$DEPLOY_FILE"

                    git add "\$DEPLOY_FILE"
                    git diff --cached --quiet || git commit -m "Updated image to build-${BUILD_NUMBER}"

                    git remote set-url origin https://${GIT_USERNAME}:${GIT_TOKEN}@github.com/modaknarayan97/Multi-Brunch-Production2026.git
                    git push origin main
                """
            }
        }
    }
}
